// Generated by CoffeeScript 1.7.1
(function() {
  var _;

  _ = require("underscore");


  /*
      
      Create a subscription object that uses one firebase ref as
      an 'index' of IDs to fetch from another firebase ref.
      
      Example:
  
       * Will look up post IDs in /users/#{ownerId}/writing,
       * and fetch the actual posts from /posts.
  
      firebaseRelationalSubscription
        indexRef: new Firebase(FIREBASE_URL+'/users/'+ownerId+'/writing').limit(limit)
        dataRef: new Firebase(FIREBASE_URL+'/posts')
        ref: new Firebase(FIREBASE_URL+'/writing')
        shouldUpdateSubscription: (oldProps, newProps) ->
          oldProps.settings.ownerId != newProps.settings.ownerId
        query: (ref, done) -> done(ref.limit(limit))
        default: _([])
        server: true
        parseObject: (snapshot) ->
            post = snapshot.val()
            post.id = snapshot.name()
            post
        parseList: (list) -> list.reverse()
   */

  module.exports = function(manifest) {
    _.extend(manifest, {
      handlers: {},
      models: {},
      modelIndex: [],
      modelIndexRemoved: [],
      parseObject: manifest.parseObject || function(snapshot) {
        var obj;
        obj = snapshot.val();
        obj.priority = snapshot.getPriority();
        obj.id = snapshot.name();
        return obj;
      },
      parseList: manifest.parseList || function(list) {
        return list;
      },
      exportModels: function() {
        var list;
        list = _.chain(this.models).pairs().map(function(pair) {
          return pair[1];
        }).sortBy(function(object) {
          return object.priority;
        });
        return this.parseList(list.value());
      },
      subscribe: function(callback, options) {
        var addChild, cancelUpdateObject, exportAllModels, removeChild, updateObject;
        if (options == null) {
          options = {};
        }
        exportAllModels = (function(_this) {
          return function() {
            if (_(_this.models).keys().length === _this.modelIndex.length) {
              return callback(_this.exportModels());
            }
          };
        })(this);
        updateObject = (function(_this) {
          return function(snapshot) {
            _this.models[snapshot.name()] = _this.parseObject(snapshot);
            return exportAllModels();
          };
        })(this);
        cancelUpdateObject = (function(_this) {
          return function(id) {
            return function() {
              _this.modelIndex = _.without(_this.modelIndex, id);
              _this.modelIndexRemoved.push(id);
              return exportAllModels();
            };
          };
        })(this);
        addChild = (function(_this) {
          return function(id) {
            var childRef;
            childRef = manifest.dataRef.child(id);
            childRef.on("value", updateObject, cancelUpdateObject(id));
            return _this.handlers[id] = {
              fn: updateObject,
              ref: childRef
            };
          };
        })(this);
        removeChild = (function(_this) {
          return function(id) {
            var _base, _ref;
            if ((_ref = _this.handlers[id]) != null) {
              if (typeof (_base = _ref.ref).off === "function") {
                _base.off();
              }
            }
            delete _this.handlers[id];
            return delete _this.models[id];
          };
        })(this);
        return manifest.indexRef.on("value", (function(_this) {
          return function(snapshot) {
            var currentKeys, existingKeys, key, newKeys, removedKeys, _i, _j, _len, _len1;
            currentKeys = _(snapshot.val()).keys();
            existingKeys = _(_this.models).keys().concat(_this.modelIndexRemoved);
            removedKeys = _(existingKeys).without(currentKeys);
            newKeys = _(currentKeys).without(existingKeys);
            _this.modelIndex = _(currentKeys).without(_this.modelIndexRemoved);
            for (_i = 0, _len = removedKeys.length; _i < _len; _i++) {
              key = removedKeys[_i];
              removeChild(key);
            }
            for (_j = 0, _len1 = newKeys.length; _j < _len1; _j++) {
              key = newKeys[_j];
              addChild(key);
            }
            return exportAllModels();
          };
        })(this));
      },
      unsubscribe: function() {
        var key, object, _ref;
        manifest.indexRef.off();
        _ref = this.handlers;
        for (key in _ref) {
          object = _ref[key];
          object.ref.off();
          delete this.handlers[key];
          delete this.models[key];
        }
        return this.modelIndex = [];
      }
    });
    return manifest;
  };

}).call(this);
