// Generated by CoffeeScript 1.7.1

/*

  Turn a firebase manifest into a subscription object.

  Example of a firebase manifest:

    ref: new Firebase(FIREBASE_URL+"/posts/"+id)
    default: {}
    parse: (snapshot) ->
         * modify the snapshot before setting into props
        post = snapshot.val()
        post.date = snapshot.getPriority() if post
        post.id = snapshot.name() if post
        post                    
    shouldUpdateSubscription: (oldProps, newProps) ->
         * a subscription can depend on the component's props.
         * when props change, we can optionally re-initialize
         * a subscription.
        oldProps.matchedRoute.params.id != newProps.matchedRoute.params.id


  Example of a subscription object:

  subscription = 
    subscribe: (callback) ->
       * whenever data changes, runs callback(data)
    unsubscribe: ->
       * cleans up
 */

(function() {
  var firebaseSyncedList, positionAfter, positionFor;

  module.exports = function(manifest) {
    manifest.subscribe = function(setData) {
      manifest.query = manifest.query || function(ref, cb) {
        return cb(ref);
      };
      return manifest.query(manifest.ref, (function(_this) {
        return function(ref) {
          var cancelUpdateObject, updateObject;
          if (ref === null) {
            manifest.inactive = true;
            setData(manifest["default"]);
            return;
          }
          manifest.queryRef = ref;
          updateObject = function(snapshot) {
            var parse, value;
            parse = manifest.parse || function(snapshot) {
              return snapshot.val();
            };
            value = parse(snapshot);
            return setData(value);
          };
          cancelUpdateObject = function() {
            return setData(manifest["default"]);
          };
          return ref.on("value", updateObject, cancelUpdateObject);
        };
      })(this));
    };
    manifest.unsubscribe = function() {
      var _ref;
      if (manifest.inactive !== true) {
        return (_ref = manifest.queryRef) != null ? _ref.off() : void 0;
      }
    };
    return manifest;
  };

  firebaseSyncedList = function(manifest) {
    var list;
    list = [];
    manifest.subscribe = function(setData) {
      manifest.query = manifest.query || function(ref, cb) {
        return cb(ref);
      };
      return manifest.query(manifest.ref, (function(_this) {
        return function(ref) {
          var cancelUpdateObject, updateObject, _add, _change, _move, _remove;
          if (ref === null) {
            manifest.inactive = true;
            setData(manifest["default"]);
            return;
          }
          manifest.queryRef = ref;
          updateObject = function(snapshot) {
            var parse, value;
            parse = manifest.parse || function(snapshot) {
              return snapshot.val();
            };
            value = parse(snapshot);
            return setData(value);
          };
          cancelUpdateObject = function() {
            return setData(manifest["default"]);
          };
          ref.on("child_added", _add = function(snap, prevChild) {
            var data, pos;
            data = snap.val();
            data.$id = snap.name();
            data.$priority = snap.getPriority();
            pos = positionAfter(list, prevChild);
            list.splice(pos, 0, data);
            return setData(list);
          });
          ref.on("child_removed", _remove = function(snap) {
            var i;
            i = positionFor(list, snap.name());
            if (i > -1) {
              list.splice(i, 1);
            }
            return setData(list);
          });
          ref.on("child_changed", _change = function(snap) {
            var i;
            i = positionFor(list, snap.name());
            if (i > -1) {
              list[i] = snap.val();
              list[i].$id = snap.name();
            }
            return setData(list);
          });
          return ref.on("child_moved", _move = function(snap, prevChild) {
            var curPos, data, newPos;
            curPos = positionFor(list, snap.name());
            if (curPos > -1) {
              data = list.splice(curPos, 1)[0];
              newPos = positionAfter(list, prevChild);
              list.splice(newPos, 0, data);
            }
            return setData(list);
          });
        };
      })(this));
    };
    manifest.unsubscribe = function() {
      var _ref;
      if (manifest.inactive !== true) {
        return (_ref = manifest.queryRef) != null ? _ref.off() : void 0;
      }
    };
    return manifest;
  };

  positionFor = function(list, key) {
    var i, len;
    i = 0;
    len = list.length;
    while (i < len) {
      if (list[i].$id === key) {
        return i;
      }
      i++;
    }
    return -1;
  };

  positionAfter = function(list, prevChild) {
    var i;
    if (prevChild === null) {
      return 0;
    } else {
      i = positionFor(list, prevChild);
      if (i === -1) {
        return list.length;
      } else {
        return i + 1;
      }
    }
  };

}).call(this);
